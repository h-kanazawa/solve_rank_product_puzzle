# 3競技の順位積による総合順位について

クライミングコンペのコンバインド部門において総合ポイント（3競技の順位の積）から、その選手が**確実に**決勝に進出できるのかを計算する

---

ミキペディアさんの疑問

https://twitter.com/mic_u/status/1094029193178824704

> わからない算数の問題があるので解けたら教えて欲しいです
> 「クライミングは3種目の順位の掛け算(合計pt)が小さい上位6人が予選を通過する。
> 絶対に予選通過できる合計ptの最大値は何点か」
> 設定を簡単にするため現実とは異なりますが
> ・同着は無し
> ・合計ptが同じ人が複数人でたら7人以上通過
> とする

ある選手P0の順位が(1,1,60)のとき、他の選手の順位がどのような組み合わせであっても、6位の選手の総合ptは60より小さくはできず、選手P0は絶対に予選突破する。総合ptが61以上の場合は何点であっても絶対に予選突破できるとは言えない。

総合pt45でも予選突破できないケースもある。逆に総合pt44以下なら絶対に予選突破できる。

以下、解法・証明など

---

# 略語の説明

- 予選通過人数を n とする（2018年までは6人だったが今後8人の場合も出てくるらしい）
- 求めたい総合ptを持つ選手を P0
- それ以外の選手を P1, P2, P3, ... Pn
- 3種目の競技を A, B, C

とする

- i ∈ { 0, 1, ..., n } において
  - 選手Piの競技Aの順位を ai
  - 選手Piの競技Bの順位を bi
  - 選手Piの競技Cの順位を ci
  - 選手Piの総合ptを ti (= ai * bi * ci)

とする

- 例
  - 選手P3の競技Bの順位は b3
  - 選手P5の総合ptは t5

---

# 解法の指針

循環構造があるので<br>
a0 <= b0 <= c0 の場合のみ考える --- (h1)

循環構造があるので<br>
a1 < a2 < a3 < ... < an の場合のみ考える

a0 <= n の場合のみ考えれば十分である<br>
なぜなら、a0 > n のとき、b0 >= n, c0 >= n となり、P1\~Pnが3競技で1\~n位を独占することで確実にP0を予選敗退にできるから

選手P0がn位の選手の総合pt（=上位n人の総合ptの最大値）と同じもしくは下回れば予選通過できる<br>
"絶対に予選通過できる"というのは、『「選手P1\~Pnの総合ptの最大値」の最小値』を考えれば良い<br>

b0, c0について、3つの場合に分けて考える

---

### (i) b0 <= n, c0 <= nの場合

bi (i=1\~n)は b0以外の {1,2,3,...,n+1} からなる場合<br>
ci (i=1\~n)は c0以外の {1,2,3,...,n+1} からなる場合<br>
だけを考えれば十分

*具体例を使って感覚的に理由を説明する*<br>
*例えばn=6, b0=3のとき*<br>
*bi(i=1\~6)が{1,2,4,5,6,8}のときの「選手P1\~P6の総合ptの最大値」*<br>
*が*<br>
*bi(i=1\~6)が{1,2,4,5,6,7}ののとき「選手P1\~P6の総合ptの最大値」*<br>
*より小さくなることはない*

---

### (ii) b0 <= n, c0 > nの場合

#### Step1: c0 == n+1 の場合

c0 を n+1 に固定し<br>
bi (i=1\~n)は b0以外の {1,2,3,...,n+1} からなる場合<br>
ci (i=1\~n)は {1,2,3,...,n} からなる場合<br>
のときの『「選手P1\~Pnの総合ptの最大値」の最小値』`X`を求める

#### Step2: c0 > n+1 の場合

Step1で求めた解 `X` と a0, b0 から c0>n+1 のときの解を探索する

---

### (iii) b0 > n, c0 > nの場合

#### Step1: c0 == n+1 の場合

b0 と c0 を n+1 に固定し<br>
bi (i=1\~n)は {1,2,3,...,n} からなる場合<br>
ci (i=1\~n)は {1,2,3,...,n} からなる場合<br>
のときの『「選手P1\~Pnの総合ptの最大値」の最小値』`X`を求める

#### Step2:

Step1で求めた解 `X` と a0 から b0>n+1, c0>n+1 のときの解を探索する

*プログラムを動かした結果、n=1~9の場合Step1の時点で解が存在しない。n=10のときはStep1の解が存在するが、Step2で追加の解は存在しなかった。n>11については調査していない*

---

# 注意

n=6のときは総当たりで計算したpython版の結果と一致したので正しいと思うが、
n>=7については[一部証明できていない仮定](https://github.com/h-kanazawa/solve_rank_product_puzzle/blob/master/main.jl#L13-L20)が含まれており、正しさについては不明

---

# 結果

- [選手P0の総合ptでソートした結果（予選通過人数6人）](./results_sorted_by_t0/6_finalists)
- [選手P0の総合ptでソートした結果（予選通過人数8人）](./results_sorted_by_t0/8_finalists)

<br>

- 結果ファイルの読み方
  - p0: 選手P0の各競技における順位
  - t0: 選手P0の総合ポイント
  - ranks: 選手P1\~Pnの各競技における順位
  - min_max_ti: 「選手P1\~Pnの総合ptの最大値」の最小値
  - must_go_final: 選手P0は"絶対に"予選突破できるか
  - inserted_at: 上記の解法で、どのstepによって求められたのか

---

# プログラムの実行

実行環境: julia v1.1.0

```
$ julia -v
julia version 1.1.0
```

実行方法

```
$ julia main.jl n
```

`n` は予選通過人数

*手元の環境だとn=8で約15秒、n=10で約30分。O(n!)の部分があるのでそれ以上のnでは計算していない*
